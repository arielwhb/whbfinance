// VERSI FINAL - SEMUA FITUR LENGKAP
console.log("app.js FINAL berhasil dimuat!");

document.addEventListener('DOMContentLoaded', () => {
    const page = window.location.pathname;
    if (page.includes('login.html') || page === '/') { setupLoginPage(); } 
    else if (page.includes('index.html')) { setupUserForm(); } 
    else if (page.includes('finance.html')) { loadFinanceDashboard(); }
    else if (page.includes('adminregis.html')) { setupAdminRegisPage(); }

    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('userRole');
            window.location.href = '/login.html';
        });
    }
});
function updateStatusColor(selectElement){if(selectElement.value==='Selesai'){selectElement.classList.add('status-selesai');selectElement.classList.remove('status-belum-selesai')}else{selectElement.classList.add('status-belum-selesai');selectElement.classList.remove('status-selesai')}}
function terbilang(angka){const bilangan=["","satu","dua","tiga","empat","lima","enam","tujuh","delapan","sembilan","sepuluh","sebelas"];angka=Math.floor(angka);if(angka<12){return bilangan[angka]}if(angka<20){return terbilang(angka-10)+" belas"}if(angka<100){return terbilang(Math.floor(angka/10))+" puluh "+terbilang(angka%10)}if(angka<200){return"seratus "+terbilang(angka-100)}if(angka<1000){return terbilang(Math.floor(angka/100))+" ratus "+terbilang(angka%100)}if(angka<2000){return"seribu "+terbilang(angka-1000)}if(angka<1000000){return terbilang(Math.floor(angka/1000))+" ribu "+terbilang(angka%1000)}if(angka<1000000000){return terbilang(Math.floor(angka/1000000))+" juta "+terbilang(angka%1000000)}if(angka<1000000000000){return terbilang(Math.floor(angka/1000000000))+" miliar "+terbilang(angka%1000000000)}if(angka<1000000000000000){return terbilang(Math.floor(angka/1000000000000))+" triliun "+terbilang(angka%1000000000000)}return"angka terlalu besar"}
function setupLoginPage(){const loginForm=document.getElementById('loginForm');if(!loginForm)return;loginForm.addEventListener('submit',async e=>{e.preventDefault();const data=Object.fromEntries(new FormData(loginForm).entries());try{const response=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await response.json();if(result.success){sessionStorage.setItem('userRole',result.role);window.location.href=result.role==='user'?'/index.html':'/finance.html'}else{document.getElementById('loginError').textContent=result.message}}catch(error){document.getElementById('loginError').textContent='Gagal terhubung ke server.'}})}
function setupAdminRegisPage(){const regisForm=document.getElementById('regisForm');const messageP=document.getElementById('regisMessage');if(!regisForm)return;regisForm.addEventListener('submit',async e=>{e.preventDefault();const data=Object.fromEntries(new FormData(regisForm).entries());try{const response=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await response.json();messageP.textContent=result.message;if(result.success){messageP.style.color='green';regisForm.reset()}else{messageP.style.color='red'}}catch(error){messageP.textContent='Gagal terhubung ke server.';messageP.style.color='red'}})}
function setupUserForm(){const form=document.getElementById('pengajuanForm');if(!form)return;const pemohonCheckBtn=document.getElementById('pemohonCheckBtn');const totalRpInput=document.getElementById('totalRp');const terbilangInput=document.getElementById('terbilang');const tanggalInput=document.getElementById('tanggal');if(tanggalInput)tanggalInput.valueAsDate=new Date();pemohonCheckBtn.addEventListener('click',()=>{pemohonCheckBtn.classList.toggle('checked');pemohonCheckBtn.innerHTML=pemohonCheckBtn.classList.contains('checked')?'✓':''});totalRpInput.addEventListener('input',e=>{let rawValue=e.target.value.replace(/[^0-9]/g,'');let numberValue=parseInt(rawValue,10)||0;if(numberValue>0){let textValue=terbilang(numberValue).replace(/\s\s+/g,' ').trim();terbilangInput.value=textValue.charAt(0).toUpperCase()+textValue.slice(1)+" rupiah"}else{terbilangInput.value=''}e.target.value=numberValue.toLocaleString('id-ID')});form.addEventListener('submit',async e=>{e.preventDefault();const formData=new FormData(form);const isChecked=pemohonCheckBtn.classList.contains('checked');formData.append('pemohon_checked',isChecked);const totalRpRaw=formData.get('totalRp').replace(/\./g,'');formData.set('totalRp',totalRpRaw);try{const response=await fetch('/api/pengajuan',{method:'POST',body:formData});if(response.ok){alert('Pengajuan berhasil dikirim!');form.reset();pemohonCheckBtn.classList.remove('checked');pemohonCheckBtn.innerHTML='';if(tanggalInput)tanggalInput.valueAsDate=new Date()}else{alert(`Gagal mengirim pengajuan: ${(await response.json()).message}`)}}catch(error){alert('Terjadi kesalahan koneksi.')}})}
let allData=[];async function loadFinanceDashboard(){try{const response=await fetch('/api/pengajuan');allData=await response.json();renderTable(allData);document.getElementById('filterNomorPO').addEventListener('input',applyFilters);document.getElementById('filterNamaPO').addEventListener('input',applyFilters);document.getElementById('filterStatus').addEventListener('change',applyFilters);setupEditModalListeners()}catch(error){console.error('Error:',error)}}
function renderTable(data){const tableBody=document.querySelector('#financeTable tbody');if(!tableBody)return;tableBody.innerHTML='';data.forEach(item=>{const row=document.createElement('tr');let attachmentLinks='Tidak ada';if(item.attachments&&item.attachments.length>0){attachmentLinks=item.attachments.map(file=>`<a href="/uploads/${file}" target="_blank" title="${file}">${file.substring(0,15)}...</a>`).join('<br>')}row.innerHTML=`<td>${item.nomorPO}</td><td>${item.tanggal||'-'}</td><td>${item.namaPO||'-'}</td><td>${item.pemohon||'Tidak Diisi'}</td><td>Rp ${parseInt(item.totalRp||0).toLocaleString('id-ID')}</td><td>${attachmentLinks}</td><td><select class="status-select" data-nomorpo="${item.nomorPO}"><option value="Belum Selesai" ${item.statusDashboard==='Belum Selesai'?'selected':''}>Belum Selesai</option><option value="Selesai" ${item.statusDashboard==='Selesai'?'selected':''}>Selesai</option></select></td><td class="action-buttons"><button class="edit-btn" data-nomorpo="${item.nomorPO}">Edit</button><button class="pdf-btn" data-nomorpo="${item.nomorPO}">PDF</button></td>`;tableBody.appendChild(row);const statusSelect=row.querySelector('.status-select');updateStatusColor(statusSelect)});document.querySelectorAll('.status-select').forEach(select=>select.addEventListener('change',updateStatus));document.querySelectorAll('.pdf-btn').forEach(button=>button.addEventListener('click',generatePdf));document.querySelectorAll('.edit-btn').forEach(button=>button.addEventListener('click',openEditModal))}
function applyFilters(){const filterNomorPO=document.getElementById('filterNomorPO').value.toLowerCase();const filterNamaPO=document.getElementById('filterNamaPO').value.toLowerCase();const filterStatus=document.getElementById('filterStatus').value;const filteredData=allData.filter(item=>{const statusMatch=filterStatus?item.statusDashboard===filterStatus:true;return item.nomorPO.toLowerCase().includes(filterNomorPO)&&(item.namaPO||'').toLowerCase().includes(filterNamaPO)&&statusMatch});renderTable(filteredData)}
async function updateStatus(e){const select=e.target;updateStatusColor(select);const nomorPO=select.dataset.nomorpo;const newStatus=select.value;try{const response=await fetch(`/api/pengajuan/${nomorPO}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({statusDashboard:newStatus})});if(response.ok){const item=allData.find(d=>d.nomorPO===nomorPO);if(item)item.statusDashboard=newStatus}else{alert('Gagal memperbarui status.')}}catch(error){alert('Terjadi kesalahan koneksi.')}}
function generatePdf(e){const nomorPO=e.target.dataset.nomorpo;e.target.innerText='...';e.target.disabled=true;window.location.href=`/api/generate-pdf/${nomorPO}`;setTimeout(()=>{e.target.innerText='PDF';e.target.disabled=false},5000)}
function openEditModal(e){const nomorPO=e.target.dataset.nomorpo;const submission=allData.find(item=>item.nomorPO===nomorPO);if(!submission)return;document.getElementById('editNomorPO').value=submission.nomorPO;document.getElementById('editTanggal').value=submission.tanggal;document.getElementById('editNamaPO').value=submission.namaPO||'';document.getElementById('editVendor').value=submission.vendor||'';document.getElementById('editTerimaDari').value=submission.terimaDari||'';document.getElementById('editPembayaran').value=submission.pembayaran||'';document.getElementById('editKeterangan').value=submission.keterangan||'';document.getElementById('editPemohon').value=submission.pemohon||'';document.getElementById('editTotalRp').value=parseInt(submission.totalRp||0).toLocaleString('id-ID');document.getElementById('editTerbilang').value=submission.terbilang||'';document.getElementById('editNamaMengetahui').value=submission.namaMengetahui||'';document.getElementById('editNamaMenyetujui').value=submission.namaMenyetujui||'';document.getElementById('editNamaPelaksana').value=submission.namaPelaksana||'';document.getElementById('editPemohonName').value=submission.pemohon||'';const approvals=submission.approvals||{};const pemohonCheck=document.getElementById('editPemohonCheck');pemohonCheck.textContent=approvals.pemohon?'✓':'-';pemohonCheck.className=approvals.pemohon?'checkmark-display checked':'checkmark-display';['mengetahui','menyetujui','pelaksana'].forEach(role=>{const btn=document.getElementById(`edit${role.charAt(0).toUpperCase()+role.slice(1)}Btn`);if(approvals[role]){btn.classList.add('checked');btn.innerHTML='✓'}else{btn.classList.remove('checked');btn.innerHTML=''}});document.getElementById('editModal').style.display='flex'}
function setupEditModalListeners(){['mengetahui','menyetujui','pelaksana'].forEach(role=>{const btn=document.getElementById(`edit${role.charAt(0).toUpperCase()+role.slice(1)}Btn`);if(btn){btn.addEventListener('click',()=>{btn.classList.toggle('checked');btn.innerHTML=btn.classList.contains('checked')?'✓':''})}});const totalRpInput=document.getElementById('editTotalRp');if(totalRpInput){totalRpInput.addEventListener('input',event=>{let rawValue=event.target.value.replace(/[^0-9]/g,'');let numberValue=parseInt(rawValue,10)||0;document.getElementById('editTerbilang').value=numberValue>0?(terbilang(numberValue).replace(/\s\s+/g,' ').trim()+" rupiah").replace(/^\w/,c=>c.toUpperCase()):'';event.target.value=numberValue.toLocaleString('id-ID')})};const cancelBtn=document.getElementById('cancelEdit');if(cancelBtn){cancelBtn.addEventListener('click',()=>{document.getElementById('editModal').style.display='none'})};const editForm=document.getElementById('editForm');if(editForm){editForm.addEventListener('submit',async e=>{e.preventDefault();const formData=new FormData(e.target);const data=Object.fromEntries(formData.entries());const nomorPO=data.nomorPO;data.totalRp=data.totalRp.replace(/\./g,'');data.mengetahui=document.getElementById('editMengetahuiBtn').classList.contains('checked');data.menyetujui=document.getElementById('editMenyetujuiBtn').classList.contains('checked');data.pelaksana=document.getElementById('editPelaksanaBtn').classList.contains('checked');try{const response=await fetch(`/api/pengajuan/edit/${nomorPO}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await response.json();if(result.success){alert(result.message);document.getElementById('editModal').style.display='none';loadFinanceDashboard()}else{alert('Gagal menyimpan perubahan: '+result.message)}}catch(error){alert('Terjadi kesalahan koneksi.')}})}}